<div *ngIf="!isMobile()" class="flex-sm-grow-1">
  <ng-container [ngTemplateOutlet]="searchBar"></ng-container>
</div>

<div class="d-block h-100 d-md-none">
  <button
    class="btn btn-side-border text-secondary w-100 h-100 rounded-0 d-flex align-items-center justify-content-center"
    data-bs-toggle="modal"
    data-bs-target="#mobileSearchModal"
    type="button"
    (click)="modalHistoryPush()"
  >
    <mat-icon>search</mat-icon>
  </button>
</div>

<div
  *ngIf="isMobile()"
  class="modal fade"
  id="mobileSearchModal"
  data-bs-backdrop="false"
  tabindex="-1"
  aria-labelledby="mobileSearchModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-fullscreen-md-down">
    <div class="modal-content">
      <div class="modal-header">
        <ng-container [ngTemplateOutlet]="searchBar"></ng-container>
        <button
          id="searchModalClose"
          type="button"
          class="btn btn-close border border-dark-subtle ms-2 me-0"
          data-bs-dismiss="modal"
          aria-label="Close"
          (click)="reset()"
        ></button>
      </div>
      <div class="mx-4 my-2">
        <ng-container [ngTemplateOutlet]="searchHeading"></ng-container>
      </div>
      <hr class="border m-0" />
      <div class="modal-body">
        <ul class="list-group fs-14 p-1 text-body-secondary">
          <ng-container
            [ngTemplateOutlet]="
              !result.data
                ? searchValue.trim().length > 2
                  ? loading
                  : null
                : resultList
            "
            [ngTemplateOutletContext]="{ data: result.data }"
          ></ng-container>
        </ul>
      </div>
    </div>
  </div>
</div>

<ng-template #searchBar>
  <div class="input-group dropdown search-bar">
    <input
      #searchInput
      #toolTip="matTooltip"
      type="text"
      class="form-control flex-grow-1 dropdown-toggle search-input"
      aria-label="Global search text input"
      [disabled]="active === '/'"
      [matTooltip]="!isMobile() ? 'Use &uarr; and &darr; to navigate' : ''"
      [matTooltipPosition]="'right'"
      [matTooltipDisabled]="true"
      [placeholder]="'Search Order, AWB, SKU or Customer'"
      (input)="setSearchValue($event)"
      (appDebounceInput)="search($event)"
      [debounceTime]="500"
      (resetEvent)="reset()"
      [minimumCharacters]="3"
      (focus)="onFocus()"
      (focusout)="onFocusOut()"
    />
    <mat-icon
      class="search-icon text-secondary"
      svgIcon="assets:search"
    ></mat-icon>
    <ul
      class="dropdown-menu w-100 search-result fs-14 p-1 text-body-secondary"
      #searchResult
      role="menu"
    >
      <li>
        <ng-container [ngTemplateOutlet]="searchHeading"></ng-container>
      </li>
      <li>
        <hr *ngIf="result.data" class="dropdown-divider" />
      </li>
      <ng-container
        [ngTemplateOutlet]="
          !result.data
            ? searchValue.trim().length > 2
              ? loading
              : null
            : resultList
        "
        [ngTemplateOutletContext]="{ data: result.data }"
      ></ng-container>
    </ul>
    <span
      class="p-1 text-primary shortcut user-select-none"
      [ngClass]="{ hide: selected }"
    >
      <kbd class="bg-primary">Ctrl</kbd> + <kbd class="bg-primary">/</kbd>
    </span>
  </div>
</ng-template>

<ng-template #searchHeading>
  <div
    class="dropdown-header text-secondary user-select-none d-flex align-items-center justify-content-between"
  >
    <span class="text-body-secondary">Search in </span>
    <div class="ms-2 d-flex flex-wrap">
      <!-- TODO: remove clear() if not needed -->
      <button
        class="btn btn-sm m-1 d-inline-flex align-items-center"
        [ngClass]="
          item === active ? 'btn-outlined_sm' : 'btn-outlined_sm-secondary'
        "
        *ngFor="let item of options"
        (click)="active = item; reset(); clear(); search(searchValue)"
      >
        <mat-icon
          class="option-icons me-2"
          [svgIcon]="OPTIONS[item]['icon']"
        ></mat-icon>
        {{ OPTIONS[item]['displayName'] }}
      </button>
    </div>
  </div>
</ng-template>

<ng-template #loading>
  <li class="dropdown-item disabled placeholder-glow">
    <span class="placeholder col-6"></span>
  </li>
  <li class="dropdown-item disabled placeholder-glow">
    <span class="placeholder col-4"></span>
  </li>
</ng-template>

<ng-template #resultList let-data="data">
  <div class="overflow-y-auto custom-scrollbar" *ngIf="data.length">
    <li
      *ngFor="let item of data; let i = index"
      aria-label="Close"
      class="dropdown-item cursor"
      [attr.data-bs-dismiss]="isMobile() ? 'modal' : null"
      tabindex="-1"
      [id]="'searchResult' + i"
      [ngClass]="{
        active: i === dropDownItemIndex,
        'list-group-item': isMobile()
      }"
      (click)="navigate(i)"
      (keydown.enter)="navigate(i)"
    >
      <p class="fw-semibold">{{ item.sku }}</p>
      <p>{{ item.name }}</p>
    </li>
  </div>
  <p class="dropdown-item disabled" *ngIf="!data.length">No results found</p>
</ng-template>
